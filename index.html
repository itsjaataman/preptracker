<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JEE/NEET/BITSAT 2025 Master Tracker - eVidhyalaya</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* slate-900 */
            color: #f8fafc; /* slate-50 */
        }

        /* Improved FirebaseUI container styling */
        #firebaseui-auth-container-wrapper {
            /* Center the login box */
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem; /* Add padding for smaller screens */
        }
        #firebaseui-auth-container {
            /* Style the inner container */
            max-width: 400px; /* Limit width */
            width: 100%; /* Take full width up to max-width */
            background-color: #1e293b; /* slate-800 */
            padding: 2rem; /* Add padding */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            border: 1px solid #334155; /* slate-700 */
        }
        /* Style FirebaseUI elements (override if necessary) */
        .firebaseui-card-header {
            background-color: transparent !important; /* Remove default header background */
            color: #f8fafc !important; /* slate-50 */
            text-align: center;
            padding-bottom: 1.5rem;
        }
        .firebaseui-title {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 600; /* font-semibold */
            color: #f8fafc !important; /* slate-50 */
        }
        .firebaseui-idp-button {
            border-radius: 0.5rem !important; /* rounded-lg */
            background-color: #4f46e5 !important; /* indigo-600 */
            color: white !important;
            transition: background-color 0.2s ease-in-out;
        }
        .firebaseui-idp-button:hover {
            background-color: #4338ca !important; /* indigo-700 */
        }
        .firebaseui-text {
             color: #cbd5e1 !important; /* slate-300 */
        }
        .firebaseui-link {
             color: #818cf8 !important; /* indigo-400 */
        }
        .firebaseui-link:hover {
             color: #6366f1 !important; /* indigo-500 */
        }
        /* Ensure input fields are visible */
         .firebaseui-input, .firebaseui-input-invalid {
            background-color: #334155 !important; /* slate-700 */
            color: #f8fafc !important; /* slate-50 */
            border: 1px solid #475569 !important; /* slate-600 */
            border-radius: 0.375rem !important; /* rounded-md */
         }
         .firebaseui-input-label {
             color: #94a3b8 !important; /* slate-400 */
         }
         .firebaseui-button {
             background-color: #6366f1 !important; /* indigo-500 */
             color: white !important;
             border-radius: 0.5rem !important; /* rounded-lg */
             transition: background-color 0.2s ease-in-out;
         }
         .firebaseui-button:hover {
             background-color: #4f46e5 !important; /* indigo-600 */
         }


        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Pulse animation */
        @keyframes pulse-glow {
            0% { transform: scale(1); box-shadow: 0 0 0 0px rgba(245, 158, 11, 0.5); }
            50% { transform: scale(1.03); box-shadow: 0 0 10px 15px rgba(245, 158, 11, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0px rgba(245, 158, 11, 0); }
        }
        .milestone-celebrate { animation: pulse-glow 1.5s ease-out; }

        /* Date input visibility */
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); }
        input[type="date"] { color-scheme: dark; }

        /* Hide sidebar scrollbar */
        .sidebar-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        .sidebar-scroll::-webkit-scrollbar { display: none; }

    </style>
    <script>
        // Tailwind Configuration
        tailwind.config = {
          darkMode: 'class',
          theme: {
            extend: {
              colors: {
                primary: { DEFAULT: '#6366f1', dark: '#4f46e5' }, // indigo-500, indigo-600
                secondary: '#a855f7', // purple-500
                accent: '#f59e0b',   // amber-500
                danger: { DEFAULT: '#ef4444', light: '#f87171' }, // red-500, red-400
                success: { DEFAULT: '#22c55e', light: '#10b981' }, // green-500, emerald-500
                bitsat: '#f472b6', // pink-400
                'card-bg': '#1e293b', // slate-800
                'bg-dark': '#0f172a', // slate-900
                'text-main': '#f8fafc', // slate-50
                'text-muted': '#94a3b8' // slate-400
              },
              fontFamily: { sans: ['Inter', 'sans-serif'], },
            }
          }
        }
      </script>
</head>
<body class="bg-bg-dark text-text-main">

    <div id="firebaseui-auth-container-wrapper">
        <div id="firebaseui-auth-container"></div>
    </div>

    <div class="exam-modal fixed inset-0 z-50 flex items-center justify-center bg-black/80" id="examModal" style="display: none;">
        <div class="bg-card-bg p-8 rounded-xl shadow-lg text-center max-w-md w-full mx-4">
            <h2 class="text-2xl font-semibold mb-6 text-text-main">Choose Your Preparation</h2>
            <div class="space-y-4 md:space-y-0 md:space-x-4 flex flex-col md:flex-row justify-center">
                <button onclick="selectExam('JEE')" class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition duration-200 ease-in-out shadow-md">JEE</button>
                <button onclick="selectExam('NEET')" class="w-full md:w-auto bg-success-light hover:bg-emerald-600 text-white font-medium py-3 px-6 rounded-lg transition duration-200 ease-in-out shadow-md">NEET</button>
                <button onclick="selectExam('BITSAT')" class="w-full md:w-auto bg-bitsat hover:bg-pink-500 text-white font-medium py-3 px-6 rounded-lg transition duration-200 ease-in-out shadow-md">BITSAT</button>
            </div>
        </div>
    </div>

    <div class="app-container md:flex min-h-screen" id="app" style="display: none;">

        <aside id="sidebar" class="sidebar-scroll fixed inset-y-0 left-0 z-40 w-64 bg-card-bg p-4 border-r border-slate-700 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col overflow-y-auto">
            <div class="text-center mb-6">
                 <h1 class="text-2xl font-bold text-primary">eVidhyalaya</h1>
                 <p class="text-sm text-text-muted">Study Tracker</p>
            </div>

            <nav class="flex-grow space-y-2">
                <a href="#" class="nav-item group flex items-center px-4 py-3 rounded-lg text-slate-300 hover:bg-slate-700 hover:text-white transition-colors duration-200" onclick="showSection('dashboard')">
                    <i class="fas fa-tachometer-alt w-5 h-5 mr-3 text-slate-400 group-hover:text-white"></i> üìä Dashboard
                </a>
                <a href="#" class="nav-item group flex items-center px-4 py-3 rounded-lg text-slate-300 hover:bg-slate-700 hover:text-white transition-colors duration-200" onclick="showSection('pomodoroSection')">
                    <i class="fas fa-clock w-5 h-5 mr-3 text-slate-400 group-hover:text-white"></i> ‚è≥ Pomodoro
                </a>
                <a href="#" class="nav-item group flex items-center px-4 py-3 rounded-lg text-slate-300 hover:bg-slate-700 hover:text-white transition-colors duration-200" onclick="showSection('mocks')">
                    <i class="fas fa-file-alt w-5 h-5 mr-3 text-slate-400 group-hover:text-white"></i> üìù Mock Tests
                </a>
                <a href="#" class="nav-item group flex items-center px-4 py-3 rounded-lg text-slate-300 hover:bg-slate-700 hover:text-white transition-colors duration-200" onclick="showSection('profileSection')">
                    <i class="fas fa-user-cog w-5 h-5 mr-3 text-slate-400 group-hover:text-white"></i> üë§ Profile
                </a>
                 <a href="#" class="nav-item group flex items-center px-4 py-3 rounded-lg text-slate-300 hover:bg-slate-700 hover:text-white transition-colors duration-200" onclick="shareWithFriends()">
                    <i class="fas fa-share-alt w-5 h-5 mr-3 text-slate-400 group-hover:text-white"></i> ü§ù Share
                </a>
            </nav>

            <div class="mt-auto pt-4 border-t border-slate-700">
                <div class="flex justify-center space-x-4 mb-3">
                    <a href="https://t.me/evidhyalaya_official" target="_blank" rel="noopener noreferrer" class="text-slate-400 hover:text-blue-400 transition-colors duration-200" aria-label="Telegram">
                        <i class="fab fa-telegram fa-lg"></i>
                    </a>
                    <a href="https://instagram.com/evidhyalayaofficial" target="_blank" rel="noopener noreferrer" class="text-slate-400 hover:text-pink-500 transition-colors duration-200" aria-label="Instagram">
                        <i class="fab fa-instagram fa-lg"></i>
                    </a>
                </div>
                <div id="quote" class="text-xs italic text-text-muted px-4 py-2 text-center mb-2"></div>
                <a href="#" class="nav-item group flex items-center px-4 py-3 rounded-lg text-slate-300 hover:bg-red-600 hover:text-white transition-colors duration-200" onclick="logout()">
                    <i class="fas fa-sign-out-alt w-5 h-5 mr-3 text-slate-400 group-hover:text-white"></i> üîí Logout
                </a>
            </div>
        </aside>

        <div id="overlay" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden" onclick="toggleSidebar()"></div>

        <main class="main-content flex-1 p-4 md:p-6 lg:p-8 overflow-y-auto flex flex-col">
            <div class="md:hidden flex justify-between items-center mb-4">
                 <h1 class="text-xl font-bold text-primary">eVidhyalaya</h1>
                 <button id="hamburgerBtn" class="text-text-main focus:outline-none" onclick="toggleSidebar()">
                     <i class="fas fa-bars text-2xl"></i>
                 </button>
            </div>

            <div id="loadingIndicator" class="loading-indicator text-center p-10 text-lg text-text-muted" style="display: none;">Loading Configuration...</div>

            <div class="flex-grow">
                <div id="dashboard" class="space-y-6" style="display: none;">
                     <h1 class="text-3xl font-bold text-text-main">Welcome to eVidhyalaya <span id="examNameDisplay" class="text-primary"></span> Tracker</h1>
                     <div id="advertisementArea" class="bg-card-bg p-4 rounded-lg border border-primary/50 text-center text-sm text-text-muted" style="display: none;">Loading advertisement...</div>
                     <div id="daysLeft" class="text-lg text-text-muted">Calculating days...</div>
                     <div id="streakDisplayContainer" class="bg-card-bg p-4 rounded-lg shadow-md border border-slate-700">
                         <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 text-center">
                             <div class="stat-item p-3 rounded-md bg-slate-700/50"><div class="text-sm text-text-muted mb-1">üî• Current Streak</div><div id="streakCount" class="text-2xl font-semibold text-accent">0</div><div class="text-xs text-text-muted">days</div></div>
                             <div class="stat-item p-3 rounded-md bg-slate-700/50"><div class="text-sm text-text-muted mb-1">üèÜ Longest Streak</div><div id="longestStreakCount" class="text-2xl font-semibold text-text-main">0</div><div class="text-xs text-text-muted">days</div></div>
                             <div class="stat-item p-3 rounded-md bg-slate-700/50"><div class="text-sm text-text-muted mb-1">‚≠ê Points</div><div id="pointsCount" class="text-2xl font-semibold text-primary">0</div><div class="text-xs text-text-muted">earned</div></div>
                             <div class="stat-item p-3 rounded-md bg-slate-700/50"><div class="text-sm text-text-muted mb-1">üèÖ Badges</div><div id="badgesDisplay" class="badges-display flex flex-wrap gap-1 justify-center items-center min-h-[28px]"></div></div>
                         </div>
                         <div class="mt-4 text-center">
                             <button id="freezeBtn" class="bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-white text-sm font-medium py-2 px-4 rounded-md transition duration-200 shadow" onclick="useStreakFreeze()" disabled>Use Freeze (<span id="freezeCount">0</span> left)</button>
                         </div>
                     </div>
                     <div id="mockReminder" class="bg-card-bg p-4 rounded-lg shadow-md border border-slate-700 text-sm text-text-muted"></div>
                     <div class="text-center bg-card-bg p-4 rounded-lg shadow-md border border-slate-700">
                         <h2 class="text-xl font-semibold text-text-main mb-2">Overall Progress: <span id="overallProgress" class="text-primary">0</span>%</h2>
                         <button onclick="shareDashboardProgress()" class="bg-secondary hover:bg-purple-600 text-white text-sm font-medium py-2 px-5 rounded-md transition duration-200 shadow"><i class="fab fa-whatsapp mr-2"></i>Share Progress</button>
                     </div>
                     <div id="chaptersGrid" class="space-y-4">Loading subjects...</div>
                 </div>

                <div id="pomodoroSection" class="space-y-6" style="display: none;">
                     <h2 class="text-3xl font-bold text-text-main">Pomodoro Timer</h2>
                     <div class="pomodoro-container bg-card-bg p-6 md:p-8 rounded-xl shadow-lg border border-slate-700 max-w-md mx-auto text-center">
                         <div id="pomodoro-mode" class="text-sm font-medium text-text-muted mb-2 uppercase tracking-wider min-h-[1.2em]">SELECT MODE</div>
                         <div id="pomodoro-time" class="text-6xl md:text-7xl font-bold mb-6 text-danger transition-colors duration-300">25:00</div>
                         <div class="pomodoro-controls flex justify-center gap-4 mb-6">
                             <button id="pomodoro-pause-resume" class="bg-accent hover:bg-amber-500 disabled:opacity-50 disabled:cursor-not-allowed text-slate-900 font-semibold py-2 px-6 rounded-lg transition duration-200 shadow" onclick="pauseResumePomodoro()" disabled>Pause</button>
                             <button id="pomodoro-reset" class="bg-slate-600 hover:bg-slate-500 disabled:opacity-50 disabled:cursor-not-allowed text-white font-semibold py-2 px-6 rounded-lg transition duration-200 shadow" onclick="resetPomodoro()" disabled>Reset</button>
                         </div>
                         <div class="pomodoro-presets grid grid-cols-1 sm:grid-cols-3 gap-3 mb-8">
                             <button class="bg-danger hover:bg-red-600 text-white font-medium py-3 px-4 rounded-lg transition duration-200 shadow" onclick="startPomodoro('work')">Start Study</button>
                             <button class="bg-success hover:bg-green-600 text-white font-medium py-3 px-4 rounded-lg transition duration-200 shadow" onclick="startPomodoro('shortBreak')">Short Break</button>
                             <button class="bg-blue-700 hover:bg-blue-800 text-white font-medium py-3 px-4 rounded-lg transition duration-200 shadow" onclick="startPomodoro('longBreak')">Long Break</button>
                         </div>
                         <div class="pomodoro-settings mt-6 pt-6 border-t border-slate-700 text-left">
                             <h4 class="text-lg font-semibold mb-3 text-text-main">Customize Durations <span class="text-sm text-text-muted">(minutes)</span></h4>
                             <div class="flex flex-wrap items-center gap-x-4 gap-y-2">
                                 <label for="workDurationInput" class="text-sm text-text-muted">Study:</label>
                                 <input type="number" id="workDurationInput" min="1" value="25" class="w-16 p-2 bg-slate-700 border border-slate-600 rounded-md text-text-main focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                 <label for="shortBreakDurationInput" class="text-sm text-text-muted">Short:</label>
                                 <input type="number" id="shortBreakDurationInput" min="1" value="5" class="w-16 p-2 bg-slate-700 border border-slate-600 rounded-md text-text-main focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                 <label for="longBreakDurationInput" class="text-sm text-text-muted">Long:</label>
                                 <input type="number" id="longBreakDurationInput" min="1" value="15" class="w-16 p-2 bg-slate-700 border border-slate-600 rounded-md text-text-main focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                 <button onclick="savePomodoroSettings()" class="bg-primary hover:bg-primary-dark text-white text-sm font-medium py-2 px-4 rounded-md transition duration-200 shadow ml-auto">Save</button>
                             </div>
                             <p id="pomodoroSaveStatus" class="text-xs text-success mt-3 min-h-[1em]"></p>
                         </div>
                     </div>
                 </div>

                <div id="mocks" class="space-y-6" style="display: none;">
                     <h2 class="text-3xl font-bold text-text-main">Mock Tests</h2>
                     <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-slate-700 space-y-4">
                         <h3 class="text-xl font-semibold text-text-main">Add New Test Result</h3>
                         <div>
                             <label for="mockName" class="block text-sm font-medium text-text-muted mb-1">Test Name / Description</label>
                             <input type="text" id="mockName" placeholder="E.g., Physics Full Syllabus Test 1" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-text-main focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent placeholder-slate-500">
                         </div>
                         <div>
                             <label for="mockMarks" class="block text-sm font-medium text-text-muted mb-1">Marks Obtained</label>
                             <input type="number" id="mockMarks" placeholder="Enter score" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-text-main focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent placeholder-slate-500">
                         </div>
                         <button onclick="addMockTest()" class="w-full bg-primary hover:bg-primary-dark text-white font-semibold py-3 px-6 rounded-lg transition duration-200 shadow-md">Add Test Result</button>
                     </div>
                     <div>
                         <h2 class="text-2xl font-semibold text-text-main mb-4">Previous Tests</h2>
                         <div id="mockTestsList" class="space-y-4"></div>
                     </div>
                 </div>

                 <div id="profileSection" class="space-y-6" style="display: none;">
                     <h2 class="text-3xl font-bold text-text-main">Profile Settings</h2>
                     <div class="profile-setting-card bg-card-bg p-6 rounded-xl shadow-lg border border-slate-700">
                         <h3 class="text-xl font-semibold text-text-main mb-2">Select Your Target Exam</h3>
                         <p class="text-sm text-text-muted mb-4">Changing exam might reset progress for non-common chapters.</p>
                         <div class="flex flex-wrap gap-x-6 gap-y-3">
                             <label class="inline-flex items-center cursor-pointer"><input type="radio" name="profileExamType" value="JEE" id="profileExamJEE" class="form-radio h-5 w-5 text-primary focus:ring-primary border-slate-600 bg-slate-700"><span class="ml-2 text-text-main">JEE</span></label>
                             <label class="inline-flex items-center cursor-pointer"><input type="radio" name="profileExamType" value="NEET" id="profileExamNEET" class="form-radio h-5 w-5 text-success-light focus:ring-success-light border-slate-600 bg-slate-700"><span class="ml-2 text-text-main">NEET</span></label>
                             <label class="inline-flex items-center cursor-pointer"><input type="radio" name="profileExamType" value="BITSAT" id="profileExamBITSAT" class="form-radio h-5 w-5 text-bitsat focus:ring-bitsat border-slate-600 bg-slate-700"><span class="ml-2 text-text-main">BITSAT</span></label>
                         </div>
                     </div>
                     <div class="profile-setting-card bg-card-bg p-6 rounded-xl shadow-lg border border-slate-700">
                         <h3 class="text-xl font-semibold text-text-main mb-2">Set Custom Exam Date <span class="text-base font-normal text-text-muted">(Optional)</span></h3>
                         <p class="text-sm text-text-muted mb-4">Leave blank or clear to use the default date set by the admin.</p>
                         <div class="flex flex-wrap items-center gap-4">
                             <input type="date" id="customDateInput" class="p-3 bg-slate-700 border border-slate-600 rounded-lg text-text-main focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent placeholder-slate-500">
                             <button onclick="clearCustomDate()" class="bg-slate-600 hover:bg-slate-500 text-white text-sm font-medium py-2 px-4 rounded-md transition duration-200 shadow">Use Default Date</button>
                         </div>
                     </div>
                     <div class="flex items-center gap-4">
                        <button onclick="saveProfile()" class="bg-primary hover:bg-primary-dark text-white font-semibold py-3 px-8 rounded-lg transition duration-200 shadow-md">Save Profile Settings</button>
                        <p id="profileSaveStatus" class="text-sm text-success"></p>
                     </div>
                 </div>
            </div>

            <footer class="mt-8 py-4 border-t border-slate-700 text-center text-sm text-text-muted">
                <div class="flex justify-center space-x-5 mb-2">
                    <a href="https://t.me/evidhyalaya_official" target="_blank" rel="noopener noreferrer" class="hover:text-blue-400 transition-colors duration-200" aria-label="Telegram">
                        <i class="fab fa-telegram fa-lg"></i> Telegram
                    </a>
                    <a href="https://instagram.com/evidhyalayaofficial" target="_blank" rel="noopener noreferrer" class="hover:text-pink-500 transition-colors duration-200" aria-label="Instagram">
                        <i class="fab fa-instagram fa-lg"></i> Instagram
                    </a>
                </div>
                ¬© <span id="currentYear"></span> eVidhyalaya. All rights reserved.
            </footer>

        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.js"></script>

    <script>
        // --- Firebase Configuration ---
        // IMPORTANT: Replace with your actual config. Keep API keys secure.const firebaseConfig = {
        //   const firebaseConfig = {
        //   apiKey: "addapikeyhere", // Replace with your actual config
        //   authDomain: "addauthdomain",
        //   projectId: "addprojectid",
        //   storageBucket: "addyourkey",
        //   messagingSenderId: "addyourkey",
        //   appId: "addyourkey",
        //   measurementId: "addyourkey"
        // };


        // --- Global Variables ---
        let firebaseInitialized = false;
        let auth, db, ui;
        let currentUser = null;
        let currentExam = null;
        let userDataUnsubscribe = null;
        let currentUserData = {};
        let globalExamConfig = null;
        let configFetchAttempted = false;

        const defaultPomodoroSettings = { work: 25, short: 5, long: 15 };
        const motivationalQuotes = [
            "The road to success is always under construction. Keep building!",
            "Your limitation‚Äîit's only your imagination. Push through!",
            "Don't watch the clock; do what it does. Keep going!",
            "The secret of getting ahead is getting started.",
            "Believe you can and you're halfway there.",
            "Strive for progress, not perfection."
        ];

        // Pomodoro Timer State
        let timerIntervalId = null;
        let timeLeftInSeconds = defaultPomodoroSettings.work * 60;
        let isPaused = false;
        let currentMode = 'work';
        let pomodoroCycles = 0;

        // --- Utility Functions ---
        function getFormattedDate(date = new Date()) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`; // YYYY-MM-DD format
        }

        // --- Sidebar Toggle Function ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            if (sidebar && overlay) {
                sidebar.classList.toggle('-translate-x-full');
                overlay.classList.toggle('hidden');
            }
        }

        // --- Firebase Initialization and Auth Handling ---
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                console.log("Firebase initialized.");
                firebaseInitialized = true;
            } else {
                firebase.app(); // if already initialized, use that one
                console.log("Firebase already initialized.");
                firebaseInitialized = true;
            }
        } catch (e) {
            console.error("CRITICAL: Firebase initialization failed.", e);
            document.body.innerHTML = `<div class="p-8 m-8 text-red-700 bg-red-100 border-2 border-red-700 rounded-lg text-center"><h1>Initialization Error</h1><p>Could not initialize Firebase. Check configuration and console.</p><pre class="text-left text-xs whitespace-pre-wrap">${e.message}</pre></div>`;
        }

        if (firebaseInitialized) {
            auth = firebase.auth();
            db = firebase.firestore();
            ui = new firebaseui.auth.AuthUI(auth);

            auth.onAuthStateChanged(async user => {
                // Reset state on auth change
                currentUser = null;
                currentExam = null;
                currentUserData = {};
                globalExamConfig = null;
                configFetchAttempted = false;
                hideAdvertisement();
                hideAppSections();
                showAuthUI(); // Show login by default

                if (user) {
                    currentUser = user;
                    console.log("User logged in:", currentUser.uid, currentUser.email);

                    if (userDataUnsubscribe) userDataUnsubscribe();

                    userDataUnsubscribe = db.collection('users').doc(currentUser.uid).onSnapshot(async doc => {
                        console.log("User data snapshot received.");
                        hideAuthUI(); // Hide login UI once user data is checked

                        if (doc.exists) {
                            currentUserData = doc.data();
                            currentExam = currentUserData.examType;

                            if (!currentExam) {
                                console.log("User exists but no exam selected. Showing modal.");
                                showExamSelectionModal();
                            } else {
                                console.log(`User has selected exam: ${currentExam}. Initializing app.`);
                                await fetchExamConfigurations();
                                initializeAppUI(currentUserData);
                                fetchAndDisplayAdvertisement();
                            }
                        } else {
                            console.log("New user detected. Showing exam selection modal.");
                            currentUserData = { email: currentUser.email };
                            showExamSelectionModal();
                        }
                    }, error => {
                        console.error("Firestore listener error:", error);
                        alert("Error loading your data. Please try refreshing the page.");
                        showLoadingIndicator('Error loading user data.');
                    });
                } else { // User logged out
                    console.log("User logged out.");
                    if (userDataUnsubscribe) { userDataUnsubscribe(); userDataUnsubscribe = null; }
                    clearPomodoroTimer();
                    showAuthUI(); // Show login UI again
                    // Ensure sidebar is hidden on logout for mobile
                    const sidebar = document.getElementById('sidebar');
                    const overlay = document.getElementById('overlay');
                    if (sidebar && overlay && !sidebar.classList.contains('-translate-x-full')) {
                         sidebar.classList.add('-translate-x-full');
                         overlay.classList.add('hidden');
                    }
                }
            });

            // Global error handlers
            window.onerror = (msg, src, line, col, err) => console.error("Unhandled error:", msg, src, line, col, err);
            window.addEventListener('unhandledrejection', e => console.error('Unhandled rejection:', e.reason));
        }

        // --- UI Visibility Control ---
        function showAuthUI() {
            // Show the wrapper which contains the styled login box
            const authWrapper = document.getElementById('firebaseui-auth-container-wrapper');
            const appContainer = document.getElementById('app');
            const examModal = document.getElementById('examModal');

            if (authWrapper) authWrapper.style.display = 'flex'; // Use flex for centering
            if (appContainer) appContainer.style.display = 'none';
            if (examModal) examModal.style.display = 'none';

            const authContainer = document.getElementById('firebaseui-auth-container');
            if (authContainer && !currentUser) {
                // Start FirebaseUI
                ui.start('#firebaseui-auth-container', {
                    signInOptions: [
                        firebase.auth.GoogleAuthProvider.PROVIDER_ID,
                        // Add other providers like email if needed
                        // firebase.auth.EmailAuthProvider.PROVIDER_ID
                    ],
                    signInFlow: 'popup', // Or 'redirect'
                    callbacks: {
                        signInSuccessWithAuthResult: () => false, // Prevent redirect, onAuthStateChanged handles it
                        uiShown: () => console.log("Auth UI shown.")
                    },
                    // Optional: Add terms of service and privacy policy URLs
                    // tosUrl: '<your-tos-url>',
                    // privacyPolicyUrl: '<your-privacy-policy-url>'
                });
            }
        }

        function hideAuthUI() {
            const authWrapper = document.getElementById('firebaseui-auth-container-wrapper');
            if (authWrapper) authWrapper.style.display = 'none';
        }

        function showExamSelectionModal() {
            const examModal = document.getElementById('examModal');
            const appContainer = document.getElementById('app');
            hideAuthUI();
            if (examModal) examModal.style.display = 'flex';
            if (appContainer) appContainer.style.display = 'none';
        }

        function hideExamSelectionModal() {
            const examModal = document.getElementById('examModal');
            if (examModal) examModal.style.display = 'none';
        }

        function showAppContainer() {
            const appContainer = document.getElementById('app');
            const loadingIndicator = document.getElementById('loadingIndicator');
            hideAuthUI();
            hideExamSelectionModal();
            if (appContainer) appContainer.style.display = 'flex'; // Use flex for md:flex layout
            if (loadingIndicator) loadingIndicator.style.display = 'none';
            // Set current year in footer
            const yearEl = document.getElementById('currentYear');
            if(yearEl) yearEl.textContent = new Date().getFullYear();
        }

        function hideAppSections() {
            const sections = ['dashboard', 'pomodoroSection', 'mocks', 'profileSection', 'loadingIndicator'];
            sections.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
        }

        function showLoadingIndicator(message = "Loading...") {
            hideAppSections();
            const indicator = document.getElementById('loadingIndicator');
            if (indicator) {
                indicator.textContent = message;
                indicator.style.display = 'block';
            }
        }

        function hideLoadingIndicator() {
            const indicator = document.getElementById('loadingIndicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
        }

        function showSection(sectionId) {
            console.log(`Showing section: ${sectionId}`);

            // Close sidebar on mobile when a section is selected
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            if (sidebar && overlay && window.innerWidth < 768 && !sidebar.classList.contains('-translate-x-full')) {
                toggleSidebar();
            }

            const configReliantSections = ['dashboard', 'profileSection'];
            if (configReliantSections.includes(sectionId) && !globalExamConfig) {
                 console.warn(`Attempted to show section '${sectionId}' before config loaded.`);
                 showLoadingIndicator('Loading configuration...');
                 fetchExamConfigurations().then(() => showSection(sectionId));
                 return;
            }

            hideAppSections(); // Hide all sections first

            const el = document.getElementById(sectionId);
            if (el) {
                el.style.display = 'block'; // Default display type
                // Load data specific to the section when shown
                if (sectionId === 'profileSection') loadProfileData();
                else if (sectionId === 'pomodoroSection') loadPomodoroSettings();
                else if (sectionId === 'dashboard') updateUIFromUserData(); // Ensure dashboard is up-to-date
                else if (sectionId === 'mocks') renderMockTests(currentUserData.mockTests || []);

            } else {
                console.error(`Section with ID '${sectionId}' not found. Showing dashboard.`);
                showSection('dashboard'); // Fallback
            }

            // Highlight active nav item
            document.querySelectorAll('#sidebar .nav-item').forEach(item => {
                 const onclickAttr = item.getAttribute('onclick');
                 // Check if onclick calls showSection with the current sectionId OR if it's the share button (which doesn't change section)
                 const isActive = onclickAttr?.includes(`showSection('${sectionId}')`);
                 item.classList.toggle('bg-slate-700', isActive);
                 item.classList.toggle('text-white', isActive);
                 item.classList.toggle('text-slate-300', !isActive);
                 const icon = item.querySelector('i');
                 if (icon) {
                     icon.classList.toggle('text-white', isActive);
                     icon.classList.toggle('text-slate-400', !isActive);
                 }
            });
        }

        // --- Exam Configuration Handling (Firestore) ---
        async function fetchExamConfigurations() {
            if (globalExamConfig || configFetchAttempted) {
                console.log("Exam config already available or fetch attempted.");
                return globalExamConfig;
            }
            console.log("Fetching exam configurations from Firestore...");
            showLoadingIndicator("Loading Exam Configuration...");
            configFetchAttempted = true;

            try {
                const configRef = db.collection('config');
                const jeeDoc = await configRef.doc('exam_JEE').get();
                const neetDoc = await configRef.doc('exam_NEET').get();
                const bitsatDoc = await configRef.doc('exam_BITSAT').get();

                const parseConfig = (doc, examName) => {
                    if (!doc.exists) {
                        console.warn(`Config document for ${examName} not found in Firestore.`);
                        return { examDate: null, subjectChapterMapping: {}, toggles: [], chapters: [] };
                    }
                    const data = doc.data();
                    let subjectChapterMapping = {};
                    // Handle both stringified JSON and direct object format
                    if (typeof data.subjectChapterMapping === 'string') {
                        try { subjectChapterMapping = JSON.parse(data.subjectChapterMapping); }
                        catch (e) { console.error(`Error parsing subjectChapterMapping JSON for ${examName}:`, e); subjectChapterMapping = {}; }
                    } else if (typeof data.subjectChapterMapping === 'object' && data.subjectChapterMapping !== null) {
                        subjectChapterMapping = data.subjectChapterMapping;
                    }
                    const chapters = Object.values(subjectChapterMapping).flat();
                    const toggles = data.toggles || getDefaultToggles(examName);
                    return { examDate: data.examDate || null, subjectChapterMapping: subjectChapterMapping, toggles: toggles, chapters: chapters };
                };

                globalExamConfig = {
                    JEE: parseConfig(jeeDoc, 'JEE'),
                    NEET: parseConfig(neetDoc, 'NEET'),
                    BITSAT: parseConfig(bitsatDoc, 'BITSAT')
                };
                console.log("Exam configurations loaded successfully:", globalExamConfig);
                hideLoadingIndicator();
                return globalExamConfig;
            } catch (error) {
                console.error("CRITICAL: Error fetching exam configurations:", error);
                showLoadingIndicator("Error loading exam configuration. Please refresh.");
                globalExamConfig = null;
                return null;
            }
        }

        function getDefaultToggles(examName) {
            switch (examName) {
                case 'JEE': return ["Lecture", "Revision", "DPPs", "Module", "Test", "Formula Sheet"];
                case 'NEET': return ["Lecture", "Short Notes", "NCERT Text", "NCERT InText", "PYQ 10 Yrs"];
                case 'BITSAT': return ["Concepts", "Practice Qs", "Revision", "Mock Test"];
                default: return ["Done"];
            }
        }

        // --- Initial App Setup ---
        async function selectExam(examType) {
            if (!firebaseInitialized || !currentUser || !db) {
                console.error("Cannot select exam: Firebase not ready or user not logged in.");
                return;
            }
            console.log(`Selecting exam: ${examType}`);
            currentExam = examType;
            const userRef = db.collection('users').doc(currentUser.uid);

            try {
                if (!globalExamConfig) await fetchExamConfigurations(); // Ensure config is loaded
                const initialUserData = {
                    email: currentUser.email,
                    examType: examType,
                    progress: {},
                    mockTests: [],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    currentStreak: 0, lastActivityDate: null, longestStreak: 0, studyPoints: 0,
                    earnedBadges: [], streakFreezesAvailable: 2, streakFreezeExpiry: null,
                    streakFreezeUsedToday: false, customExamDate: null,
                    pomodoroSettings: defaultPomodoroSettings
                };
                // Use set with merge:true to create or update the document safely
                await userRef.set(initialUserData, { merge: true });
                console.log("User exam type and initial data set successfully.");
                hideExamSelectionModal();
                initializeAppUI(initialUserData); // Initialize UI with potentially merged data
                fetchAndDisplayAdvertisement();
            } catch (error) {
                console.error("Error setting exam type or initial data:", error);
                alert("Could not save your exam choice. Please try again.");
                currentExam = null; // Reset exam choice on error
                showExamSelectionModal(); // Show modal again
            }
        }

        function initializeAppUI(userData) {
            if (!currentExam || !currentUser || !globalExamConfig) {
                console.error("Cannot initialize UI: Missing user, exam selection, or configuration.");
                showLoadingIndicator("Error initializing. Please refresh.");
                return;
            }
            console.log("Initializing application UI...");
            currentUserData = userData; // Ensure local data is up-to-date
            showAppContainer();
            showSection('dashboard'); // Show dashboard by default
            const examNameEl = document.getElementById('examNameDisplay');
            if (examNameEl) examNameEl.textContent = currentExam;
            updateUIFromUserData(); // Populate data
            updateQuote();
            setInterval(updateQuote, 3600000); // Update quote every hour
            console.log("Application UI initialized successfully.");
        }

        // --- UI Update Functions ---
        function updateUIFromUserData() {
             if (!currentUserData || !globalExamConfig || !currentExam) {
                 console.warn("Attempted to update UI without necessary data.");
                 return;
             }
             console.log("Updating UI elements based on user data and config...");

             updateDaysLeft();
             updateMockReminder();
             renderDashboard(currentUserData.progress || {}); // Re-render dashboard subjects/progress

             // Update Stats Display
             const streakEl = document.getElementById('streakCount');
             const longestStreakEl = document.getElementById('longestStreakCount');
             const pointsEl = document.getElementById('pointsCount');
             const badgesEl = document.getElementById('badgesDisplay');
             const freezeBtn = document.getElementById('freezeBtn');
             const freezeCountEl = document.getElementById('freezeCount');

             if (streakEl) streakEl.textContent = currentUserData.currentStreak || 0;
             if (longestStreakEl) longestStreakEl.textContent = currentUserData.longestStreak || 0;
             if (pointsEl) pointsEl.textContent = currentUserData.studyPoints || 0;
             if (badgesEl) {
                 badgesEl.innerHTML = (currentUserData.earnedBadges || [])
                     .map(badge => `<span class="badge inline-block bg-success-light text-white text-xs font-semibold px-2 py-0.5 rounded-full shadow">${badge.replace(/_/g, ' ')}</span>`)
                     .join('');
                 if (!badgesEl.innerHTML) {
                     badgesEl.innerHTML = `<span class="text-xs text-text-muted">No badges yet</span>`;
                 }
             }
             const freezes = currentUserData.streakFreezesAvailable || 0;
             if (freezeCountEl) freezeCountEl.textContent = freezes;
             if (freezeBtn) freezeBtn.disabled = freezes <= 0 || currentUserData.streakFreezeUsedToday;

             // Update other sections if they are visible (to refresh data)
             if (document.getElementById('mocks')?.style.display !== 'none') renderMockTests(currentUserData.mockTests || []);
             if (document.getElementById('profileSection')?.style.display !== 'none') loadProfileData();
             if (document.getElementById('pomodoroSection')?.style.display !== 'none') loadPomodoroSettings();
         }

        // --- Dashboard Specific Updates ---
        function renderDashboard(progressData = {}) {
            updateOverallProgress(progressData); // Update overall % first
            const chaptersGrid = document.getElementById('chaptersGrid');
            if (!chaptersGrid || !globalExamConfig || !currentExam) {
                 chaptersGrid.innerHTML = '<p class="text-amber-500">Error: Cannot render dashboard. Config missing.</p>';
                 return;
            }
            const config = globalExamConfig[currentExam];
            if (!config || !config.subjectChapterMapping) {
                chaptersGrid.innerHTML = '<p class="text-amber-500">Error: Exam configuration not found or invalid.</p>';
                return;
            }

            // Render Subject Cards
            chaptersGrid.innerHTML = Object.keys(config.subjectChapterMapping).map(subject => {
                const chaptersInSubject = config.subjectChapterMapping[subject] || [];
                const totalProgress = chaptersInSubject.reduce((sum, chapter) => {
                    const chapterProg = (progressData[chapter] && typeof progressData[chapter].progress === 'number') ? progressData[chapter].progress : 0;
                    return sum + chapterProg;
                }, 0);
                const subjectProgress = chaptersInSubject.length > 0 ? (totalProgress / chaptersInSubject.length) : 0;
                const escapedSubject = subject.replace(/'/g, "\\'"); // Escape for onclick

                return `
                    <div class="subject-card bg-card-bg p-4 rounded-lg shadow-md border border-slate-700 cursor-pointer hover:bg-slate-700 transition duration-200" onclick="renderSubjectChapters('${escapedSubject}')">
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="text-lg font-semibold text-text-main">${subject}</h2>
                            <span class="text-sm font-medium text-primary">${subjectProgress.toFixed(1)}%</span>
                        </div>
                        <div class="w-full bg-slate-600 rounded-full h-2 overflow-hidden">
                            <div class="bg-gradient-to-r from-primary to-secondary h-full rounded-full transition-all duration-300 ease-out" style="width: ${subjectProgress.toFixed(1)}%;"></div>
                        </div>
                    </div>`;
            }).join('');

             if (Object.keys(config.subjectChapterMapping).length === 0) {
                chaptersGrid.innerHTML = '<p class="text-text-muted text-center mt-4">No subjects configured for this exam yet.</p>';
            }
        }

        async function renderSubjectChapters(subject) {
            console.log(`Rendering chapters for: ${subject}`);
            const chaptersGrid = document.getElementById('chaptersGrid');
            if (!chaptersGrid || !currentUser || !globalExamConfig || !currentExam) {
                 chaptersGrid.innerHTML = '<p class="text-amber-500">Error: Cannot render chapters. Config or user missing.</p>';
                 return;
            }
            const config = globalExamConfig[currentExam];
            if (!config || !config.subjectChapterMapping || !config.subjectChapterMapping[subject]) {
                chaptersGrid.innerHTML = '<p class="text-amber-500">Error: Subject configuration not found.</p>';
                return;
            }
            const chapters = config.subjectChapterMapping[subject];
            const toggles = config.toggles || getDefaultToggles(currentExam);

            const userRef = db.collection('users').doc(currentUser.uid);
            try {
                // Fetch the latest progress data directly when rendering chapters
                const doc = await userRef.get();
                if (!doc.exists) {
                     chaptersGrid.innerHTML = '<p class="text-red-500">Error: User data not found.</p>';
                     return;
                }
                const progressData = doc.data().progress || {};
                currentUserData.progress = progressData; // Update local cache

                // Chapter Card HTML
                chaptersGrid.innerHTML = `
                    <button onclick="showSection('dashboard')" class="mb-4 bg-slate-600 hover:bg-slate-500 text-white text-sm font-medium py-2 px-4 rounded-md transition duration-200 shadow">
                        <i class="fas fa-arrow-left mr-2"></i> Back to Subjects
                    </button>` +
                    chapters.map(chapter => {
                        const chapterProgress = (progressData[chapter] && typeof progressData[chapter].progress === 'number') ? progressData[chapter].progress : 0;
                        const chapterToggles = (progressData[chapter] && typeof progressData[chapter].toggles === 'object') ? progressData[chapter].toggles : {};
                        const safeChapterId = chapter.replace(/[^a-zA-Z0-9-_]/g, ''); // Sanitize ID
                        const escapedChapter = chapter.replace(/'/g, "\\'"); // Escape for onclick/onchange

                        return `
                        <div class="chapter-card bg-card-bg p-4 rounded-lg shadow-md border border-slate-700 mb-4">
                            <h3 class="text-md font-semibold text-text-main mb-3">${chapter}</h3>
                            <div class="w-full bg-slate-600 rounded-full h-1.5 mb-4 overflow-hidden">
                                <div class="progress-fill bg-gradient-to-r from-primary to-secondary h-full rounded-full transition-all duration-300 ease-out" id="progress-${safeChapterId}" style="width: ${chapterProgress.toFixed(1)}%;"></div>
                            </div>
                            <div class="toggle-grid grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-x-4 gap-y-2">
                                ${toggles.map(toggle => {
                                    const isChecked = chapterToggles[toggle] || false;
                                    const safeToggleId = toggle.replace(/[^a-zA-Z0-9-_]/g, '');
                                    const uniqueId = `toggle-${safeChapterId}-${safeToggleId}`;
                                    const escapedToggle = toggle.replace(/'/g, "\\'"); // Escape for onchange

                                    return `
                                    <label for="${uniqueId}" class="flex items-center cursor-pointer text-sm text-slate-300 hover:text-white transition-colors">
                                        <input type="checkbox" id="${uniqueId}" ${isChecked ? 'checked' : ''}
                                               onchange="updateProgress(event, '${escapedChapter}', '${escapedToggle}')"
                                               class="form-checkbox h-4 w-4 rounded text-primary bg-slate-600 border-slate-500 focus:ring-primary focus:ring-offset-0 focus:ring-opacity-50 mr-2 cursor-pointer">
                                        ${toggle}
                                    </label>`;
                                }).join('')}
                            </div>
                        </div>`;
                    }).join('');
            } catch (error) {
                console.error("Error rendering subject chapters:", error);
                chaptersGrid.innerHTML = '<p class="text-red-500">Could not load chapter details.</p>';
            }
        }

        function updateOverallProgress(progressData = {}) {
             const el = document.getElementById('overallProgress');
             if (!el || !globalExamConfig || !currentExam) {
                 if (el) el.textContent = 'N/A';
                 return;
             }
             const config = globalExamConfig[currentExam];
             if (!config || !config.chapters || config.chapters.length === 0) {
                 el.textContent = 'N/A';
                 return;
             }
             const totalChapters = config.chapters.length;
             const totalSum = config.chapters.reduce((sum, chapter) => {
                 const chapterProg = (progressData[chapter] && typeof progressData[chapter].progress === 'number') ? progressData[chapter].progress : 0;
                 return sum + chapterProg;
             }, 0);
             const average = totalChapters > 0 ? (totalSum / totalChapters) : 0;
             el.textContent = average.toFixed(1);
         }

        function updateDaysLeft() {
            const el = document.getElementById('daysLeft');
            if (!el || !currentExam || !globalExamConfig) {
                if(el) el.innerHTML = "Exam date info unavailable.";
                return;
            }
            const config = globalExamConfig[currentExam];
            let examDateToUse = null;
            let dateIsCustom = false;
            let defaultDateSource = null;

            // Prioritize custom date if valid
            if (currentUserData && currentUserData.customExamDate) {
                const customDate = new Date(currentUserData.customExamDate + 'T00:00:00'); // Ensure time is midnight UTC
                if (!isNaN(customDate.getTime())) {
                    examDateToUse = customDate;
                    dateIsCustom = true;
                    console.log("Using custom date:", currentUserData.customExamDate);
                } else {
                    console.warn("Invalid custom date format:", currentUserData.customExamDate);
                }
            }
            // Fallback to default config date if custom date not set or invalid
            if (!examDateToUse) {
                if (config && config.examDate) {
                    defaultDateSource = new Date(config.examDate + 'T00:00:00'); // Ensure time is midnight UTC
                    if (!isNaN(defaultDateSource.getTime())) {
                        examDateToUse = defaultDateSource;
                        console.log("Using default date from config:", config.examDate);
                    } else {
                        console.warn("Invalid default date format in config:", config.examDate);
                    }
                }
            }

            if (!examDateToUse) {
                el.innerHTML = "Exam date not set.";
                console.log("No valid exam date found.");
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0); // Set today to midnight local time
            // examDateToUse is already midnight UTC from parsing

            const diffTime = examDateToUse - today; // Difference in milliseconds
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); // Calculate days difference

            const year = examDateToUse.getFullYear();
            let note = dateIsCustom
                ? `<br><small class="text-xs text-slate-400">(Using your custom date)</small>`
                : `<br><small class="text-xs text-slate-400">(Default date)</small>`;

            if (diffDays > 0) {
                el.innerHTML = `<strong class="text-primary">${diffDays}</strong> Day${diffDays !== 1 ? 's' : ''} Left for ${currentExam} ${year}${note}`;
            } else if (diffDays === 0) {
                el.innerHTML = `<strong class='text-primary'>Exam is Today! Good luck!</strong>${note}`;
            } else {
                el.innerHTML = `${currentExam} ${year} has passed. (<strong class="text-red-500">${Math.abs(diffDays)}</strong> day${Math.abs(diffDays) !== 1 ? 's' : ''} ago)${note}`;
            }
        }

        function updateMockReminder() {
            const el = document.getElementById('mockReminder');
            if (!el || !currentExam) return;
            let reminder = "";
            switch(currentExam) {
                case 'JEE': reminder = "Aim for 1 mock test every 1-2 weeks, increasing frequency closer to the exam."; break;
                case 'NEET': reminder = "Regular mock tests are crucial. Aim for 1 per week initially, increasing frequency later."; break;
                default: reminder="Practice mock tests regularly to assess your preparation."; break;case 'BITSAT' : reminder = "Attempt 2-3 mock Test Per Week "
            }
            el.innerHTML = `<i class="fas fa-lightbulb mr-2 text-yellow-400"></i> Reminder: ${reminder}`;
        }

        // --- Progress Handling (Chapter Toggles) ---
        async function updateProgress(event, chapter, toggle) {
            if (!currentUser || !db || !globalExamConfig || !currentExam) return;
            const isChecked = event.target.checked;
            console.log(`Updating progress: ${chapter} -> ${toggle}: ${isChecked}`);
            const userRef = db.collection('users').doc(currentUser.uid);
            const config = globalExamConfig[currentExam];
            const totalToggles = (config?.toggles?.length > 0) ? config.toggles.length : 1;

            try {
                await db.runTransaction(async (t) => {
                    const doc = await t.get(userRef);
                    if (!doc.exists) throw new Error("User document missing!");
                    const data = doc.data();
                    const progress = data.progress || {};
                    if (!progress[chapter]) progress[chapter] = { toggles: {}, progress: 0 };
                    if (!progress[chapter].toggles) progress[chapter].toggles = {};
                    progress[chapter].toggles[toggle] = isChecked;
                    const completedCount = Object.values(progress[chapter].toggles).filter(Boolean).length;
                    progress[chapter].progress = (completedCount / totalToggles) * 100;
                    t.update(userRef, { [`progress.${chapter}`]: progress[chapter] }); // Use dot notation for specific field update
                });
                console.log(`Progress update successful for ${chapter}.`);
                // Update local cache and UI after successful transaction
                const latestDoc = await userRef.get(); // Fetch latest data to ensure consistency
                currentUserData.progress = latestDoc.exists ? latestDoc.data().progress || {} : {};
                updateOverallProgress(currentUserData.progress); // Update overall %
                // Update the specific chapter progress bar visually
                const safeChapterId = chapter.replace(/[^a-zA-Z0-9-_]/g, '');
                const progressBarFill = document.getElementById(`progress-${safeChapterId}`);
                if (progressBarFill) {
                    progressBarFill.style.width = `${currentUserData.progress[chapter]?.progress || 0}%`;
                }
            } catch (error) {
                console.error("Error updating progress in transaction:", error);
                event.target.checked = !isChecked; // Revert checkbox state on error
                alert("Error saving progress. Please try again.");
            }
        }

        // --- Streak Logic (Triggered by Pomodoro) ---
        async function updateStreakOnPomodoroCompletion() {
            if (!currentUser || !db || !currentUserData) {
                console.error("Streak Check Precondition Failed: Missing user, db, or user data.");
                return;
            }
            console.log("Checking streak logic on Pomodoro work session completion...");
            const todayStr = getFormattedDate();
            const lastActivityStr = currentUserData.lastActivityDate;

            // If activity already recorded today OR freeze was used today (and not overridden by activity)
            if (lastActivityStr === todayStr) {
                console.log("Streak activity already recorded for today.");
                // If a freeze was marked as used but activity happened anyway, reset the flag
                if (currentUserData.streakFreezeUsedToday) {
                    console.log("Resetting streakFreezeUsedToday flag as activity occurred.");
                    try {
                        await db.collection('users').doc(currentUser.uid).update({ streakFreezeUsedToday: false });
                        currentUserData.streakFreezeUsedToday = false; // Update local cache
                        updateUIFromUserData(); // Refresh UI (e.g., enable freeze button if needed)
                    } catch(error) { console.error("Error resetting streak freeze flag after activity:", error); }
                }
                return; // No further action needed
            }

            // If freeze was used today and no activity has happened yet
            if (currentUserData.streakFreezeUsedToday) {
                 console.log("Streak freeze was used today. Streak maintained but not incremented. Marking activity.");
                 try {
                     // Mark activity for today but don't increment streak, reset freeze flag
                     await db.collection('users').doc(currentUser.uid).update({
                         streakFreezeUsedToday: false,
                         lastActivityDate: todayStr
                     });
                     currentUserData.streakFreezeUsedToday = false;
                     currentUserData.lastActivityDate = todayStr;
                     updateUIFromUserData();
                     console.log("Reset streakFreezeUsedToday flag and marked activity for today (due to freeze).");
                 } catch(error) { console.error("Error resetting streak freeze flag:", error); }
                 return; // No streak increment or points
            }

            // --- Proceed with normal streak update ---
            const userRef = db.collection('users').doc(currentUser.uid);
            let updates = {};
            let newStreak = currentUserData.currentStreak || 0;
            let newLongest = currentUserData.longestStreak || 0;
            let newPoints = (currentUserData.studyPoints || 0) + 2; // Award 2 points for activity
            let newBadges = Array.isArray(currentUserData.earnedBadges) ? [...currentUserData.earnedBadges] : [];
            const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = getFormattedDate(yesterday);

            if (!lastActivityStr) { // First ever activity
                console.log("First activity (Pomodoro), starting streak at 1.");
                newStreak = 1;
            } else if (lastActivityStr === yesterdayStr) { // Continued streak
                newStreak++;
                console.log(`Streak continued (Pomodoro): Now ${newStreak} days`);
            } else if (lastActivityStr < yesterdayStr) { // Streak broken
                console.log(`Streak broken (Pomodoro) (Last activity: ${lastActivityStr}). Resetting to 1.`);
                newStreak = 1;
            }
            // If lastActivityStr === todayStr, it's handled at the beginning.

            // Check for milestones
            const milestones = { 1: "First_Step", 7: "Weekly_Warrior", 30: "Monthly_Master", 45: "Dedicated_Disciple", 90: "Quarterly_Quest", 180: "Half_Year_Hero", 365: "Yearly_Legend" };
            let milestoneReached = false;
            let badgeName = null;
            if (milestones[newStreak]) {
                badgeName = milestones[newStreak];
                console.log(`Milestone Reached: ${newStreak} days! Potential Badge: ${badgeName}`);
                if (!newBadges.includes(badgeName)) {
                    milestoneReached = true;
                    newBadges.push(badgeName);
                    updates.earnedBadges = firebase.firestore.FieldValue.arrayUnion(badgeName); // Use arrayUnion for atomic update
                    console.log(`Awarding new badge: ${badgeName}`);
                    // Award bonus points for milestones
                    if (newStreak === 7) newPoints += 50; else if (newStreak === 30) newPoints += 150; else if (newStreak === 45) newPoints += 250; else if (newStreak === 90) newPoints += 500; else if (newStreak === 180) newPoints += 1000; else if (newStreak === 365) newPoints += 2500;
                    // Add pulse animation
                    const streakContainer = document.getElementById('streakDisplayContainer');
                    if (streakContainer) { streakContainer.classList.add('milestone-celebrate'); setTimeout(() => streakContainer.classList.remove('milestone-celebrate'), 1500); }
                } else { console.log(`Milestone ${newStreak} days reached, but badge "${badgeName}" already earned.`); }
            }

            // Update longest streak if necessary
            if (newStreak > newLongest) {
                newLongest = newStreak;
                updates.longestStreak = newLongest;
                console.log(`New longest streak: ${newLongest}`);
            }

            // Prepare final updates
            updates.currentStreak = newStreak;
            updates.lastActivityDate = todayStr;
            updates.studyPoints = newPoints;
            updates.streakFreezeUsedToday = false; // Ensure this is reset

            try {
                await userRef.update(updates);
                console.log("Streak data updated successfully in Firestore via Pomodoro.", updates);
                // Update local cache AFTER successful Firestore update
                currentUserData = { ...currentUserData, ...updates, earnedBadges: newBadges }; // Update badges locally too
                updateUIFromUserData(); // Refresh relevant parts of the UI
                if (milestoneReached) setTimeout(() => alert(`üéâ Milestone Reached: ${newStreak}-day streak! You earned the ${badgeName.replace(/_/g, ' ')} badge!`), 100);
            } catch (error) { console.error("Error updating streak data in Firestore:", error); }
        }

        async function useStreakFreeze() {
             if (!currentUser || !db || !currentUserData) return;
             const freezesAvailable = currentUserData.streakFreezesAvailable || 0;
             if (freezesAvailable <= 0) { alert("You don't have any streak freezes left!"); return; }
             if (currentUserData.streakFreezeUsedToday) { alert("You have already used a streak freeze today."); return; }
             const todayStr = getFormattedDate();
             if (currentUserData.lastActivityDate === todayStr) {
                 alert("You've already completed a study session today, no need to use a freeze!");
                 return;
             }
             if (!confirm(`Use one streak freeze? (${freezesAvailable - 1} will remain)\n\nThis will protect your streak if you miss today, but you won't gain a day or points today.`)) return;

             console.log("Using streak freeze...");
             const userRef = db.collection('users').doc(currentUser.uid);
             try {
                 await userRef.update({
                     streakFreezesAvailable: firebase.firestore.FieldValue.increment(-1),
                     streakFreezeUsedToday: true // Mark freeze as used for today
                 });
                 console.log("Streak freeze used successfully.");
                 // Update local cache after successful Firestore update
                 currentUserData.streakFreezesAvailable = (currentUserData.streakFreezesAvailable || 0) - 1;
                 currentUserData.streakFreezeUsedToday = true;
                 updateUIFromUserData(); // Refresh UI (disable button)
                 alert("Streak freeze activated for today! Your streak is safe if you miss activity.");
             } catch (error) { console.error("Error using streak freeze:", error); alert("Could not use streak freeze. Please try again."); }
         }

        // --- Mock Test Handling ---
        async function addMockTest() {
            const nameInput = document.getElementById('mockName');
            const marksInput = document.getElementById('mockMarks');
            if (!nameInput || !marksInput || !currentUser || !db) return;
            const name = nameInput.value.trim();
            const marks = marksInput.value;
            if (!name) { alert("Please enter a name or description for the mock test."); return; }
            if (marks === '' || isNaN(Number(marks))) { alert("Please enter valid numerical marks obtained."); return; }
            const marksValue = Number(marks);
            console.log(`Adding mock test: ${name}, Marks: ${marksValue}`);
            const userRef = db.collection('users').doc(currentUser.uid);
            const newTest = { name: name, marks: marksValue, date: getFormattedDate() }; // Add date automatically
            try {
                // Atomically add the new test to the array
                await userRef.update({ mockTests: firebase.firestore.FieldValue.arrayUnion(newTest) });
                console.log("Mock test added successfully.");
                nameInput.value = ''; marksInput.value = ''; // Clear inputs
                // The onSnapshot listener will automatically update the UI
            } catch (e) { console.error("Error adding mock test:", e); alert("Could not add the mock test result. Please try again."); }
        }

        async function deleteMockTest(testName, testDate) {
            if (!currentUser || !db || !confirm(`Are you sure you want to delete this mock test result?\n\nName: ${testName}\nDate: ${testDate}`)) return;
            console.log(`Attempting to delete mock test: Name="${testName}", Date="${testDate}"`);
            const userRef = db.collection('users').doc(currentUser.uid);
            // Create the object representation of the test to remove
            const testToRemove = { name: testName, date: testDate };
            // We need to fetch the marks to match the exact object for arrayRemove
            try {
                const doc = await userRef.get();
                if (!doc.exists) throw new Error("User document not found.");
                const tests = doc.data().mockTests || [];
                const foundTest = tests.find(t => t.name === testName && t.date === testDate);

                if (!foundTest) {
                    console.warn(`Mock test with Name="${testName}" and Date="${testDate}" not found for deletion.`);
                    alert(`Could not find the specified test to delete.`);
                    return;
                }

                // Atomically remove the exact test object from the array
                await userRef.update({ mockTests: firebase.firestore.FieldValue.arrayRemove(foundTest) });
                console.log(`Mock test "${testName}" deleted successfully.`);
                // The onSnapshot listener will automatically update the UI
            } catch (e) {
                console.error(`Error deleting mock test "${testName}":`, e);
                alert(`Could not delete the mock test result for "${testName}". Please try again.`);
            }
        }

        function renderMockTests(mockTests = []) {
            console.log("Rendering mock tests...");
            const listEl = document.getElementById('mockTestsList');
            if (!listEl) return;
            // Sort tests by date, most recent first
            const sortedTests = mockTests.sort((a, b) => (b.date || "").localeCompare(a.date || ""));
            const escapeQuote = (str) => str ? str.replace(/'/g, "\\'") : ''; // Helper for onclick

            listEl.innerHTML = sortedTests.map(test => {
                 const escapedName = escapeQuote(test.name);
                 const escapedDate = escapeQuote(test.date);
                return `
                <div class="mock-test-card bg-card-bg p-4 rounded-lg shadow-md border border-slate-700 relative">
                    <button onclick="deleteMockTest('${escapedName}', '${escapedDate}')"
                            class="absolute top-3 right-3 bg-danger/80 hover:bg-danger text-white w-7 h-7 rounded-full flex items-center justify-center transition duration-200 text-xs shadow"
                            aria-label="Delete test">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                    <h4 class="text-md font-semibold text-text-main mb-1 pr-8">${test.name || 'Unnamed Test'}</h4>
                    <p class="text-sm text-text-muted">Date: ${test.date || 'N/A'}</p>
                    <p class="text-sm text-text-muted">Marks: <span class="font-medium text-primary">${typeof test.marks === 'number' ? test.marks : 'N/A'}</span></p>
                </div>`;
                }).join('');

            if (mockTests.length === 0) {
                listEl.innerHTML = '<p class="text-text-muted text-center mt-4">No mock test results added yet.</p>';
            }
        }

        // --- Profile Settings ---
        function loadProfileData() {
            if (!currentUserData || !globalExamConfig) { console.warn("Cannot load profile data: Missing user data or config."); return; }
            console.log("Loading profile settings data...");
            const currentExamType = currentUserData.examType || currentExam; // Use local data
            // Set radio buttons
            const jeeRadio = document.getElementById('profileExamJEE');
            const neetRadio = document.getElementById('profileExamNEET');
            const bitsatRadio = document.getElementById('profileExamBITSAT');
            if (jeeRadio) jeeRadio.checked = (currentExamType === 'JEE');
            if (neetRadio) neetRadio.checked = (currentExamType === 'NEET');
            if (bitsatRadio) bitsatRadio.checked = (currentExamType === 'BITSAT');
            // Set custom date input
            const customDateInput = document.getElementById('customDateInput');
            if (customDateInput) customDateInput.value = currentUserData.customExamDate || '';
            // Clear status message
            const statusEl = document.getElementById('profileSaveStatus');
            if (statusEl) statusEl.textContent = '';
        }

        function clearCustomDate() {
            const customDateInput = document.getElementById('customDateInput');
            if (customDateInput) { customDateInput.value = ''; console.log("Custom date input cleared."); }
        }

        async function saveProfile() {
            if (!currentUser || !db) { alert("You must be logged in to save profile settings."); return; }
            const statusEl = document.getElementById('profileSaveStatus');
            if (statusEl) statusEl.textContent = 'Saving...';

            // Get selected exam type
            let selectedExam = null;
            if (document.getElementById('profileExamJEE').checked) selectedExam = 'JEE';
            else if (document.getElementById('profileExamNEET').checked) selectedExam = 'NEET';
            else if (document.getElementById('profileExamBITSAT').checked) selectedExam = 'BITSAT';

            // Get custom date (null if empty)
            const customDateInput = document.getElementById('customDateInput');
            const customDateValue = customDateInput.value ? customDateInput.value : null;

            const updates = {};
            let examChanged = false;
            let dateChanged = false;

            // Check if exam type changed
            if (selectedExam && selectedExam !== currentUserData.examType) {
                updates.examType = selectedExam;
                examChanged = true;
                console.log(`Exam type changed to: ${selectedExam}`);
            }
            // Check if custom date changed (handle nulls correctly)
            const currentCustomDate = currentUserData.customExamDate || null;
            if (customDateValue !== currentCustomDate) {
                updates.customExamDate = customDateValue; // Store null if cleared
                dateChanged = true;
                console.log(`Custom date changed to: ${customDateValue}`);
            }

            // Only save if there are actual changes
            if (!examChanged && !dateChanged) {
                if (statusEl) statusEl.textContent = 'No changes detected.';
                setTimeout(() => { if (statusEl) statusEl.textContent = ''; }, 3000);
                return;
            }

            const userRef = db.collection('users').doc(currentUser.uid);
            try {
                await userRef.update(updates);
                console.log("Profile settings updated successfully in Firestore.");

                // Update local cache immediately after successful save
                if (examChanged) currentUserData.examType = selectedExam;
                if (dateChanged) currentUserData.customExamDate = customDateValue;

                // Re-initialize or update UI based on changes
                if (examChanged) {
                    currentExam = selectedExam; // Update global variable
                    await fetchExamConfigurations(); // Re-fetch config if needed (might have different toggles/chapters)
                    initializeAppUI(currentUserData); // Re-initialize fully to reflect new exam structure
                } else if (dateChanged) {
                     updateDaysLeft(); // Just update days left if only date changed
                }

                if (statusEl) statusEl.textContent = 'Profile saved successfully!';
                setTimeout(() => { if (statusEl) statusEl.textContent = ''; }, 3000);
            } catch (error) {
                console.error("Error saving profile settings:", error);
                if (statusEl) statusEl.textContent = 'Error saving profile.';
                alert("Could not save your profile settings. Please try again.");
            }
        }

        // --- Pomodoro Timer ---
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60); const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        async function updateTimerDisplay() { // Made async to await streak update
            const timeEl = document.getElementById('pomodoro-time');
            const modeEl = document.getElementById('pomodoro-mode');
            const pauseBtn = document.getElementById('pomodoro-pause-resume');
            const settings = currentUserData?.pomodoroSettings || defaultPomodoroSettings;
            if (!timeEl || !modeEl || !pauseBtn) return;

            if (timerIntervalId && !isPaused) {
                if (timeLeftInSeconds > 0) {
                    timeLeftInSeconds--;
                } else { // Timer finished
                    const finishedMode = currentMode;
                    clearInterval(timerIntervalId); timerIntervalId = null;
                    pauseBtn.textContent = 'Pause'; pauseBtn.disabled = true;
                    document.getElementById('pomodoro-reset').disabled = true;
                    document.title = "Timer Finished! - eVidhyalaya";

                    // --- STREAK UPDATE TRIGGER ---
                    if (finishedMode === 'work') {
                        console.log("Work session finished. Updating streak...");
                        await updateStreakOnPomodoroCompletion(); // Await the streak update before proceeding
                        pomodoroCycles++;
                    }
                    // --- END STREAK UPDATE ---

                    // Determine next state
                    let message = ""; let nextMode = 'work'; let nextDuration = (settings.work || 25);
                    let nextModeText = "START STUDY"; let nextTimeColorClass = 'text-danger'; // Default to study color

                    if (finishedMode === 'work') {
                        if (pomodoroCycles % 4 === 0) { // Long break after 4 cycles
                            nextMode = 'longBreak'; nextDuration = (settings.long || 15);
                            message = `Study session complete! Time for a long break (${nextDuration} min).`;
                            nextModeText = "START LONG BREAK"; nextTimeColorClass = 'text-blue-500'; // Long break color
                        } else { // Short break
                            nextMode = 'shortBreak'; nextDuration = (settings.short || 5);
                            message = `Study session complete! Time for a short break (${nextDuration} min).`;
                            nextModeText = "START SHORT BREAK"; nextTimeColorClass = 'text-success'; // Short break color
                        }
                    } else { // A break finished, start work
                        nextMode = 'work'; nextDuration = (settings.work || 25);
                        message = `Break's over! Time to start your next study session (${nextDuration} min).`;
                        nextModeText = "START STUDY";
                    }

                    // Update UI for the next state
                    modeEl.textContent = nextModeText;
                    timeLeftInSeconds = nextDuration * 60;
                    timeEl.textContent = formatTime(timeLeftInSeconds);
                    timeEl.classList.remove('text-danger', 'text-success', 'text-blue-500');
                    timeEl.classList.add(nextTimeColorClass);

                    alert(message); // Notify user
                    // Optional: Play sound here
                }
            }
            // Update time display continuously if running or paused
             if (timeEl) timeEl.textContent = formatTime(timeLeftInSeconds);
            // Update page title
            if (timerIntervalId && !isPaused) {
                 const currentModeText = modeEl ? modeEl.textContent : "Timer";
                 document.title = `${formatTime(timeLeftInSeconds)} - ${currentModeText}`;
            } else if (!timerIntervalId && !isPaused && timeLeftInSeconds <= 0) { // Timer finished state
                 document.title = "Timer Finished! - eVidhyalaya";
            } else if (isPaused) { // Paused state
                 document.title = `Paused - ${formatTime(timeLeftInSeconds)}`;
            } else { // Idle state (after reset or initial load)
                 document.title = "Pomodoro Timer - eVidhyalaya";
            }
        }

        function startPomodoro(mode) {
            console.log(`Starting Pomodoro: ${mode}`);
            clearPomodoroTimer(); // Clear any existing timer
            const settings = currentUserData?.pomodoroSettings || defaultPomodoroSettings;
            const workSecs = (settings.work || 25) * 60; const shortBreakSecs = (settings.short || 5) * 60; const longBreakSecs = (settings.long || 15) * 60;
            currentMode = mode;
            isPaused = false;
            const timeEl = document.getElementById('pomodoro-time'); const modeEl = document.getElementById('pomodoro-mode'); const pauseBtn = document.getElementById('pomodoro-pause-resume'); const resetBtn = document.getElementById('pomodoro-reset');
            if (!timeEl || !modeEl || !pauseBtn || !resetBtn) return;

            timeEl.classList.remove('text-danger', 'text-success', 'text-blue-500'); // Reset color

            // Set time and UI based on mode
            switch (mode) {
                case 'work':
                    timeLeftInSeconds = workSecs;
                    modeEl.textContent = 'STUDY SESSION';
                    timeEl.classList.add('text-danger');
                    break;
                case 'shortBreak':
                    timeLeftInSeconds = shortBreakSecs;
                    modeEl.textContent = 'SHORT BREAK';
                    timeEl.classList.add('text-success');
                    break;
                case 'longBreak':
                    timeLeftInSeconds = longBreakSecs;
                    modeEl.textContent = 'LONG BREAK';
                    timeEl.classList.add('text-blue-500');
                    break;
                default: // Fallback to work mode
                    timeLeftInSeconds = workSecs;
                    modeEl.textContent = 'STUDY SESSION';
                    timeEl.classList.add('text-danger');
                    currentMode = 'work';
            }

            updateTimerDisplay(); // Show initial time
            timerIntervalId = setInterval(updateTimerDisplay, 1000); // Start the interval

            // Enable controls
            pauseBtn.textContent = 'Pause'; pauseBtn.disabled = false;
            resetBtn.disabled = false;
        }

        function pauseResumePomodoro() {
            const pauseBtn = document.getElementById('pomodoro-pause-resume');
            if (!pauseBtn || pauseBtn.disabled) return; // Don't do anything if timer isn't running

            isPaused = !isPaused;
            pauseBtn.textContent = isPaused ? 'Resume' : 'Pause';
            console.log(isPaused ? "Pomodoro timer paused" : "Pomodoro timer resumed");

            if (isPaused) {
                clearInterval(timerIntervalId); // Stop the interval
                timerIntervalId = null;
            } else {
                // Resume: Start the interval again
                if (timeLeftInSeconds > 0) {
                    timerIntervalId = setInterval(updateTimerDisplay, 1000);
                } else {
                    // If resuming when time is 0 (unlikely but possible), update display
                     updateTimerDisplay();
                     pauseBtn.textContent = 'Pause'; // Reset button text
                     pauseBtn.disabled = true; // Disable pause as timer is finished
                }
            }
            updateTimerDisplay(); // Update display immediately (for title and potentially time)
        }

        function resetPomodoro() {
            const pauseBtn = document.getElementById('pomodoro-pause-resume'); const resetBtn = document.getElementById('pomodoro-reset'); const modeEl = document.getElementById('pomodoro-mode'); const timeEl = document.getElementById('pomodoro-time');
            if (!pauseBtn || !resetBtn || !modeEl || !timeEl) return;

            clearPomodoroTimer(); // Stop any running timer

            const settings = currentUserData?.pomodoroSettings || defaultPomodoroSettings;
            // Reset time based on the *last active* mode before reset
            switch (currentMode) {
                case 'work': timeLeftInSeconds = (settings.work || 25) * 60; break;
                case 'shortBreak': timeLeftInSeconds = (settings.short || 5) * 60; break;
                case 'longBreak': timeLeftInSeconds = (settings.long || 15) * 60; break;
                default: timeLeftInSeconds = (settings.work || 25) * 60; currentMode = 'work'; // Default reset to work mode
            }

            // Reset UI to idle state
            modeEl.textContent = `SELECT MODE`;
            timeEl.classList.remove('text-success', 'text-blue-500'); // Remove break colors
            timeEl.classList.add('text-danger'); // Reset to default study color
            pauseBtn.textContent = 'Pause'; pauseBtn.disabled = true; // Disable controls
            resetBtn.disabled = true;
            pomodoroCycles = 0; // Reset cycle count on manual reset

            updateTimerDisplay(); // Update display to show reset time and title
            console.log("Pomodoro timer reset.");
        }

        function clearPomodoroTimer() {
             if (timerIntervalId) { clearInterval(timerIntervalId); timerIntervalId = null; }
             isPaused = false; // Ensure pause state is reset
             console.log("Cleared existing pomodoro interval and reset pause state.");
        }

        function loadPomodoroSettings() {
            if (!currentUserData) return;
            console.log("Loading pomodoro settings into UI...");
            const settings = currentUserData.pomodoroSettings || defaultPomodoroSettings;
            const workInput = document.getElementById('workDurationInput'); const shortInput = document.getElementById('shortBreakDurationInput'); const longInput = document.getElementById('longBreakDurationInput'); const statusEl = document.getElementById('pomodoroSaveStatus');
            if (workInput) workInput.value = settings.work || 25; if (shortInput) shortInput.value = settings.short || 5; if (longInput) longInput.value = settings.long || 15; if (statusEl) statusEl.textContent = ''; // Clear save status
        }

        async function savePomodoroSettings() {
            if (!currentUser || !db) { alert("Not logged in. Cannot save settings."); return; }
            const workInput = document.getElementById('workDurationInput'); const shortInput = document.getElementById('shortBreakDurationInput'); const longInput = document.getElementById('longBreakDurationInput'); const statusEl = document.getElementById('pomodoroSaveStatus');
            const workVal = parseInt(workInput.value); const shortVal = parseInt(shortInput.value); const longVal = parseInt(longInput.value);
            // Validate input
            if (isNaN(workVal) || workVal < 1 || isNaN(shortVal) || shortVal < 1 || isNaN(longVal) || longVal < 1) { alert("Please enter valid durations (must be numbers greater than 0)."); if (statusEl) statusEl.textContent = 'Invalid input.'; return; }
            if (statusEl) statusEl.textContent = 'Saving...';
            const newSettings = { work: workVal, short: shortVal, long: longVal };
            const userRef = db.collection('users').doc(currentUser.uid);
            try {
                await userRef.update({ pomodoroSettings: newSettings });
                console.log("Pomodoro settings saved:", newSettings);
                currentUserData.pomodoroSettings = newSettings; // Update local cache
                if (statusEl) statusEl.textContent = 'Durations saved!';
                // If timer is idle, reset it to reflect new durations immediately
                if (!timerIntervalId && !isPaused) {
                    resetPomodoro();
                }
                setTimeout(() => { if (statusEl) statusEl.textContent = ''; }, 3000);
            } catch (error) { console.error("Error saving pomodoro settings:", error); if (statusEl) statusEl.textContent = 'Error saving.'; alert("Could not save the duration settings."); }
        }

        // --- Advertisement Handling ---
        async function fetchAndDisplayAdvertisement() {
            const adArea = document.getElementById('advertisementArea');
            if (!adArea || !db) return;
            console.log("Fetching advertisement content...");
            try {
                const adRef = db.collection('config').doc('advertisement');
                const doc = await adRef.get();
                if (doc.exists) {
                    const adData = doc.data();
                    if (adData.htmlContent) {
                        adArea.innerHTML = adData.htmlContent; // Inject HTML content
                        adArea.style.display = 'block';
                        console.log("Advertisement displayed.");
                    } else {
                        adArea.innerHTML = '';
                        adArea.style.display = 'none';
                        console.log("Advertisement content is empty.");
                    }
                } else {
                    console.log("Advertisement document ('config/advertisement') doesn't exist.");
                    adArea.style.display = 'none';
                }
            } catch (error) {
                console.error("Error fetching advertisement:", error);
                adArea.innerHTML = ''; // Clear on error
                adArea.style.display = 'none';
            }
        }

        function hideAdvertisement() {
             const adArea = document.getElementById('advertisementArea');
             if (adArea) adArea.style.display = 'none';
        }

        // --- Sharing Functions ---
        function shareDashboardProgress() {
            if (!currentExam || !globalExamConfig) { alert("Cannot share progress: Exam data not loaded."); return; }
            const progress = document.getElementById('overallProgress')?.textContent || 'N/A';
            const daysLeftEl = document.getElementById('daysLeft');
            const daysText = daysLeftEl ? (daysLeftEl.innerHTML.split('<br>')[0].replace(/<[^>]*>/g, '').trim() || 'N/A') : 'N/A';
            const streakCount = currentUserData.currentStreak || 0;
            const trackerUrl = "https://shorturl.at/VcIjO"; // <-- ADDED URL

            // Construct the message including the tracker URL
            const msg = `My ${currentExam} Progress on eVidhyalaya Tracker:\n\n` +
                        `üìä Overall: ${progress}%\n` +
                        `üóìÔ∏è ${daysText}\n` +
                        `üî• Current Streak: ${streakCount} days\n\n` +
                        `Track your own progress here: ${trackerUrl}\n\n` + // <-- ADDED URL HERE
                        `Check it out!`;

            try {
                // Open WhatsApp share link
                window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`);
            } catch (e) {
                console.error("Share failed:", e);
                alert("Could not open WhatsApp to share.");
            }
        }

        // NEW: Share with Friends Function
        function shareWithFriends() {
            const appUrl = window.location.href; // Get the current page URL
            const trackerUrl = "https://shorturl.at/VcIjO"; // Specific tracker URL
            const msg = `Hey! I'm using this awesome eVidhyalaya Study Tracker to prepare for my exams. It helps track progress, manage time with Pomodoro, and stay motivated. \n\nCheck it out: ${trackerUrl}\n\nLet's ace these exams together! üí™`;

            try {
                // Try using the Web Share API first for a native sharing experience
                if (navigator.share) {
                    navigator.share({
                        title: 'eVidhyalaya Study Tracker',
                        text: msg,
                        url: trackerUrl // Share the specific tracker URL
                    }).then(() => console.log('Successful share'))
                      .catch((error) => console.log('Error sharing', error));
                } else {
                    // Fallback to WhatsApp link if Web Share API is not available
                    console.log("Web Share API not supported, falling back to WhatsApp.");
                    window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`);
                }
            } catch (e) {
                console.error("Share failed:", e);
                // Fallback alert if even WhatsApp fails (e.g., popup blocker)
                alert("Could not open sharing options. You can manually share this link: " + trackerUrl);
            }
        }


        // --- Other ---
        function updateQuote() {
            const el = document.getElementById('quote');
            if (el) el.textContent = `"${motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)]}"`;
        }

        function logout() {
            if (!auth) return;
            console.log("Logging out user...");
            auth.signOut()
                .then(() => { console.log("Sign-out successful."); }) // onAuthStateChanged will handle UI/state reset
                .catch(e => { console.error("Sign-out error:", e); alert("Error logging out."); });
        }

        // --- Initial Setup ---
        // (No changes needed here, using onclick attributes)

    </script>
</body>
</html>
